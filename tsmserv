
---
- name: Ensure Quantum VTL partition is removed
  hosts: vtl
  become: yes
  vars:
    vtl_ip: "192.168.1.100"
    vtl_user: "admin"
    vtl_password: "password"
    partition_id: "1"

  tasks:
    - name: Check if the VTL is offline
      shell: |
        vtl --status
      register: vtl_status

    - name: Fail if the VTL is not offline
      fail:
        msg: "The VTL is not offline. Aborting the partition removal."
      when: '"offline" not in vtl_status.stdout'

    - name: List existing partitions
      shell: |
        vtl --list partitions
      register: partition_list

    - name: Print the existing partitions
      debug:
        var: partition_list.stdout

    - name: Remove the specified partition
      shell: |
        vtl --remove partition {{ partition_id }}
      when: '"{{ partition_id }}" in partition_list.stdout'
      register: remove_partition

    - name: Print removal command output
      debug:
        var: remove_partition.stdout

    - name: Verify the partition is removed
      shell: |
        vtl --list partitions
      register: partition_list_after_removal

    - name: Print the remaining partitions
      debug:
        var: partition_list_after_removal.stdout
