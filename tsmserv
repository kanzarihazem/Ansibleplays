
---
- name: Check TSM Server Compliance
  block:
    - name: Check RAM (Minimum 384GB)
      command: free -m | awk '/^Mem/ {if ($2 >= 393216) exit 0; else exit 1}'
      register: ram_check
      failed_when: ram_check.rc != 0
      ignore_errors: yes  # Ignore errors, as this check might not work on all systems

    - name: Check Minimum CPU Cores (Minimum 2)
      command: nproc --all
      register: cpu_cores
      failed_when: cpu_cores.stdout | int < 2

    - name: Count FC Adapters
      command: lspci | grep -i 'Fibre Channel'
      register: fc_adapters
      changed_when: false  # Do not consider it a change if adapters are found
      register: fc_adapter_count

    - name: Print FC Adapters
      debug:
        var: fc_adapters.stdout_lines
      when: fc_adapter_count.stdout_lines | length > 0

    - name: Get Network Interfaces (Name Only)
      command: ip link | grep -o '^[0-9]+:\s\w*'
      register: network_interfaces
      changed_when: false  # Do not consider it a change
      register: network_interface_count

    - name: Print Network Interfaces (Name Only)
      debug:
        var: network_interfaces.stdout_lines
      when: network_interface_count.stdout_lines | length > 0

    - name: Check TSMBA Configuration
      block:
        - name: Check DB-type LUNs for database
          # Replace with your actual command to check the number and size of DB-type LUNs for the database
          command: lvs | grep -c 'DB-type.*100G'
          register: db_lun_count
          failed_when: db_lun_count.stdout != "10"

        - name: Check DB-type LUNs for active logs
          # Replace with your actual command to check the number and size of DB-type LUNs for active logs
          command: lvs | grep -c 'DB-type.*100G.*active logs'
          register: active_logs_lun_count
          failed_when: active_logs_lun_count.stdout != "3"

        - name: Check STG-type LUNs for storage pools
          # Replace with your actual command to check the number and size of STG-type LUNs for storage pools
          command: lvs | grep -c 'STG-type.*300G'
          register: stg_lun_count
          failed_when: stg_lun_count.stdout < "18"

        - name: Check STG-type LUNs for archive logs
          # Replace with your actual command to check the number and size of STG-type LUNs for archive logs
          command: lvs | grep -c 'STG-type.*300G.*archive logs'
          register: archive_logs_lun_count
          failed_when: archive_logs_lun_count.stdout != "3"
      when: "'TSMBA' in inventory_hostname"

    - name: Check TSMBA LF Configuration
      block:
        - name: Check DB-type LUNs for database
          # Replace with your actual command to check the number and size of DB-type LUNs for the database
          command: lvs | grep -c 'DB-type.*100G'
          register: db_lun_count
          failed_when: db_lun_count.stdout != "10"

        - name: Check DB-type LUNs for active logs
          # Replace with your actual command to check the number and size of DB-type LUNs for active logs
          command: lvs | grep -c 'DB-type.*100G.*active logs'
          register: active_logs_lun_count
          failed_when: active_logs_lun_count.stdout != "3"

        - name: Check for no STGpool disks
          # Replace with your actual command to check if there are no STGpool disks configured
          command: tsm show stgpool | grep -cE 'No STGpool disks'
          register: stgpool_disks_count
          failed_when: stgpool_disks_count.stdout != "1"
      when: "'TSMBA LF' in inventory_hostname"

    - name: Check TSM HT Configuration
      block:
        - name: Check DB-type LUNs for database
          # Replace with your actual command to check the number and size of DB-type LUNs for the database
          command: lvs | grep -c 'DB-type.*100G'
          register: db_lun_count
          failed_when: db_lun_count.stdout != "10"

        - name: Check DB-type LUNs for active logs
          # Replace with your actual command to check the number and size of DB-type LUNs for active logs
          command: lvs | grep -c 'DB-type.*100G.*active logs'
          register: active_logs_lun_count
          failed_when: active_logs_lun_count.stdout != "3"

        - name: Check STG-type LUN for storage pools
          # Replace with your actual command to check the number and size of STG-type LUNs for storage pools
          command: lvs | grep -c 'STG-type.*300G'
          register: stg_lun_count
          failed_when: stg_lun_count.stdout < "1"

        - name: Check STG-type LUNs for archive logs
          # Replace with your actual command to check the number and size of STG-type LUNs for archive logs
          command: lvs | grep -c 'STG-type.*300G.*archive logs'
          register: archive_logs_lun_count
          failed_when: archive_logs_lun_count.stdout != "1"
      when: "'TSM HT' in inventory_hostname"

    - name: Check TSM VE Configuration
      block:
        - name: Check DB-type LUNs for database
          # Replace with your actual command to check the number and size of DB-type LUNs for the database
          command: lvs | grep -c 'DB-type.*100G'
          register: db_lun_count
          failed_when: db_lun_count.stdout != "3"

        - name: Check DB-type LUNs for active logs
          # Replace with your actual command to check the number and size of DB-type LUNs for active logs
          command: lvs | grep -c 'DB-type.*100G.*active logs'
          register: active_logs_lun_count
          failed_when: active_logs_lun_count.stdout != "2"

        - name: Check STG-type LUNs for storage pools
          # Replace with your actual command to check the number and size of STG-type LUNs for storage pools
          command: lvs | grep -c 'STG-type.*300G'
          register: stg_lun_count
          failed_when: stg_lun_count.stdout < "10"

        - name: Check STG-type LUNs for archive logs
          # Replace with your actual command to check the number and size of STG-type LUNs for archive logs
          command: lvs | grep -c 'STG-type.*300G.*archive logs'
          register: archive_logs_lun_count
          failed_when: archive_logs_lun_count.stdout != "3"
      when: "'TSM VE' in inventory_hostname"

  tags:
    - tsm_compliance
---
dependencies: []
