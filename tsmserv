---
- name: Ensure REAR backup script exists
  stat:
    path: "{{ rear_sh }}"
  register: rear_sh_stat

- name: Fail if REAR backup script is not found
  fail:
    msg: "### Impossible to launch system backup REAR, verify that {{ rear_sh }} is present and not empty on this server."
  when: not rear_sh_stat.stat.exists or rear_sh_stat.stat.size == 0

- name: Execute REAR backup script
  shell: "{{ rear_sh }}"
  args:
    chdir: /tmp
  async: 0
  poll: 0
  register: rear_backup_result

- name: Wait for REAR backup process to complete
  async_status:
    jid: "{{ rear_backup_result.ansible_job_id }}"
  register: rear_backup_status
  until: rear_backup_status.finished
  retries: 10
  delay: 10

- name: Fail if REAR backup did not complete successfully
  fail:
    msg: "### REAR system backup failed. Backup process did not complete successfully."
  when: rear_backup_status.rc != 0

- name: Log success message if REAR backup completed successfully
  debug:
    msg: "### REAR system backup completed successfully."

check_backup_rear.yml
